<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 매출 및 손익현황 대시보드</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;900&display=swap');

        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --bg-card-hover: #253349;
            --border: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --accent-cyan: #06b6d4;
            --accent-pink: #ec4899;
            --accent-orange: #f97316;
            --gradient-blue: linear-gradient(135deg, #3b82f6, #1d4ed8);
            --gradient-green: linear-gradient(135deg, #10b981, #059669);
            --gradient-red: linear-gradient(135deg, #ef4444, #dc2626);
            --gradient-purple: linear-gradient(135deg, #8b5cf6, #7c3aed);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-bottom: 1px solid var(--border);
            padding: 24px 40px;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .update-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .refresh-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-blue);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px 40px 60px;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 28px;
        }

        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-blue);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .kpi-card:nth-child(1)::before { background: var(--gradient-blue); }
        .kpi-card:nth-child(2)::before { background: var(--gradient-red); }
        .kpi-card:nth-child(3)::before { background: var(--gradient-green); }
        .kpi-card:nth-child(4)::before { background: var(--gradient-purple); }

        .kpi-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .kpi-sub {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .kpi-trend {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .trend-up {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }

        .trend-down {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        /* Chart Grid */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 28px;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s;
        }

        .chart-card:hover {
            box-shadow: var(--shadow);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
        }

        .chart-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 320px;
        }

        .chart-container.tall {
            height: 400px;
        }

        /* Insights Section */
        .insights-section {
            margin-bottom: 28px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .insight-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s;
        }

        .insight-card:hover {
            border-color: var(--accent-blue);
            box-shadow: var(--shadow);
        }

        .insight-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-bottom: 16px;
        }

        .insight-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .insight-desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .insight-metric {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .insight-metric-label {
            color: var(--text-muted);
        }

        .insight-metric-value {
            font-weight: 600;
        }

        /* Table Section */
        .table-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            overflow: hidden;
            margin-bottom: 28px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table thead th {
            background: rgba(59, 130, 246, 0.1);
            padding: 12px 16px;
            text-align: right;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
        }

        .data-table thead th:first-child {
            text-align: left;
        }

        .data-table tbody td {
            padding: 10px 16px;
            text-align: right;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
            white-space: nowrap;
        }

        .data-table tbody td:first-child {
            text-align: left;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .data-table tbody tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .data-table .row-total {
            font-weight: 700;
            color: var(--accent-blue);
        }

        .data-table .row-profit {
            font-weight: 700;
        }

        .data-table .positive {
            color: var(--accent-green);
        }

        .data-table .negative {
            color: var(--accent-red);
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 16px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 12px;
            border-top: 1px solid var(--border);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .insights-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .container { padding: 16px; }
            .header { padding: 16px; }
            .kpi-grid { grid-template-columns: 1fr; }
            .chart-grid { grid-template-columns: 1fr; }
            .insights-grid { grid-template-columns: 1fr; }
            .kpi-value { font-size: 22px; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">데이터를 불러오는 중...</div>
    </div>

    <header class="header">
        <div class="header-content">
            <div>
                <h1>2025 매출 및 손익현황 대시보드</h1>
            </div>
            <div class="header-info">
                <div class="update-status">
                    <div class="status-dot"></div>
                    <span id="lastUpdate">마지막 업데이트: -</span>
                </div>
                <button class="refresh-btn" onclick="refreshData()">&#8635; 새로고침</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- KPI Cards -->
        <div class="kpi-grid" id="kpiGrid"></div>

        <!-- Main Charts -->
        <div class="chart-grid">
            <div class="chart-card full-width">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">월별 매출 vs 비용 vs 영업이익</div>
                        <div class="chart-subtitle">Monthly Revenue vs Expenses vs Operating Profit</div>
                    </div>
                </div>
                <div class="chart-container tall">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">매출 채널별 비중</div>
                        <div class="chart-subtitle">Revenue by Payment Channel</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="revenueChannelChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">비용 구조 분석</div>
                        <div class="chart-subtitle">Expense Structure Breakdown</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="expenseBreakdownChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">월별 영업이익률</div>
                        <div class="chart-subtitle">Monthly Operating Margin %</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="marginChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">매출 채널별 월간 추이</div>
                        <div class="chart-subtitle">Revenue Channel Monthly Trend</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="channelTrendChart"></canvas>
                </div>
            </div>

            <div class="chart-card full-width">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">주요 비용 항목 월별 추이</div>
                        <div class="chart-subtitle">Major Expense Categories Monthly Trend</div>
                    </div>
                </div>
                <div class="chart-container tall">
                    <canvas id="expenseTrendChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">누적 매출 / 누적 비용</div>
                        <div class="chart-subtitle">Cumulative Revenue vs Expenses</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="cumulativeChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">인건비 비율 추이</div>
                        <div class="chart-subtitle">Labor Cost Ratio Trend</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="laborRatioChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Business Insights -->
        <div class="insights-section">
            <div class="section-title">
                &#128161; 비즈니스 인사이트
            </div>
            <div class="insights-grid" id="insightsGrid"></div>
        </div>

        <!-- Data Table -->
        <div class="table-card">
            <div class="chart-header">
                <div>
                    <div class="chart-title">월별 상세 데이터</div>
                    <div class="chart-subtitle">단위: 원 (공급가 기준, VAT 별도)</div>
                </div>
            </div>
            <div style="overflow-x: auto;">
                <table class="data-table" id="dataTable"></table>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>데이터 소스: Google Sheets (자동 동기화) &middot; 5분마다 자동 업데이트 &middot; 공급가 기준 (VAT 별도)</p>
    </div>

    <script>
    // ============================================================
    // DATA CONFIGURATION
    // ============================================================
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTs9jQggIDdvMBLL1kIM5mnmMuy4hRPIQM9b4qwTmyI4kgB5Z-81VB_MX7yUWCOh6MZtOtTdqzpUnxA/pub?gid=0&output=csv';
    const AUTO_REFRESH_MS = 5 * 60 * 1000; // 5 minutes

    const MONTHS = ['3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];

    // Fallback data (extracted from your spreadsheet)
    const FALLBACK_DATA = {
        months: MONTHS,
        revenue: {
            total: [380586909, 101432367, 163874205, 165120833, 359163965, 642826632, 346991783, 252406283, 232322471, 262756567],
            payapp: [380586909, 65866733, 92099105, 112094833, 233258228, 356188268, 140617746, 84451820, 83959103, 122514565],
            kcp_toss: [0, 34909000, 67541100, 53664000, 119886100, 245082000, 104301673, 39572000, 0, 113888100],
            danal: [0, 5087000, 8584000, 1899000, 7437000, 18570000, 4872000, 4636000, 6187000, 6751000],
            etc: [0, 296000, 0, 888000, 4407636, 31131364, 99000364, 128446464, 142426367, 21002902]
        },
        expenses: {
            total: [0, 151990866, 161601619, 104273660, 202016770, 293604724, 251777461, 278900928, 203619898, 262839263],
            salary: [0, 48547437, 47380595, 45098008, 46341535, 48761453, 47845438, 49310412, 45316484, 57616580],
            incentive: [0, 6047075, 5012500, 1245000, 7338000, 14600549, 4552150, 3019950, 6682500, 3634000],
            freelancer: [0, 31864749, 46449900, 47048170, 71261199, 85803930, 64881841, 129974198, 60669170, 78581937],
            fees: [0, 5683370, 8240295, 12510336, 25065239, 34052011, 25349579, 23517444, 24571413, 31498812],
            advertising: [0, 15757232, 12194009, 17546869, 21166008, 21166008, 18781324, 9845271, 17913657, 37465375],
            welfare: [0, 397818, 845640, 532550, 895285, 627300, 2745650, 750501, 1381640, 1011508],
            communication: [0, 257391, 404650, 424230, 357530, 392630, 292130, 199830, 456820, 1006125],
            supplies: [0, 1332773, 1873400, 266900, 640000, 820210, 18040, 499200, 140887, 6376720],
            printing: [0, 86400, 23320, 1062432, 1512585, 662090, 247220, 185050, 10340, 5125983],
            rent: [0, 11080000, 9680000, 8320000, 8320000, 7320000, 7320000, 8520000, 12280000, 16000000],
            insurance: [0, 0, 1787500, 0, 944500, 15000, 214500, 1430000, 477950, 5325800],
            transport: [0, 23545, 79000, 324210, 801750, 1750, 64800, 300580, 372610, 2247095],
            entertainment: [0, 483900, 0, 312300, 1140000, 0, 100000, 213600, 2466200, 23400],
            tax: [0, 0, 104180, 218750, 48240, 162000, 0, 952740, 540000, 2160910]
        },
        operatingProfit: [380586909, -50558499, 2272586, 60847173, 157147195, 349221908, 95214322, -26494645, 28702573, -82696]
    };

    let chartInstances = {};
    let currentData = null;

    // ============================================================
    // DATA FETCHING
    // ============================================================
    async function fetchSheetData() {
        try {
            const response = await fetch(SHEET_CSV_URL);
            if (!response.ok) throw new Error('Fetch failed');
            const csvText = await response.text();
            const parsed = parseCSVData(csvText);
            if (parsed && parsed.revenue && parsed.revenue.total.length > 0) {
                return parsed;
            }
        } catch (e) {
            console.log('Live fetch failed, using fallback data:', e.message);
        }
        return FALLBACK_DATA;
    }

    function parseCSVData(csvText) {
        try {
            const result = Papa.parse(csvText, { header: false, skipEmptyLines: false });
            const rows = result.data;

            // Find key rows by scanning for Korean labels
            let data = {
                months: MONTHS,
                revenue: { total: [], payapp: [], kcp_toss: [], danal: [], etc: [] },
                expenses: {
                    total: [], salary: [], incentive: [], freelancer: [], fees: [],
                    advertising: [], welfare: [], communication: [], supplies: [],
                    printing: [], rent: [], insurance: [], transport: [],
                    entertainment: [], tax: []
                },
                operatingProfit: []
            };

            const labelMap = {
                '매출소계': 'revenue_total',
                '페이앱': 'payapp',
                'KCP': 'kcp_toss',
                '토스페이': 'kcp_toss',
                '다날': 'danal',
                '급여': 'salary',
                '인센티브': 'incentive',
                '프리랜서': 'freelancer',
                '지급수수료': 'fees',
                '광고선전비': 'advertising',
                '복리후생비': 'welfare',
                '통신비': 'communication',
                '소모품비': 'supplies',
                '도서인쇄비': 'printing',
                '임차료': 'rent',
                '보험료': 'insurance',
                '교통비': 'transport',
                '접대비': 'entertainment',
                '세금과공과': 'tax',
                '판매비와관리비소계': 'expense_total',
                '판매비와 관리비소계': 'expense_total',
                '영업이익': 'operating_profit'
            };

            // Find months header row and data column offsets
            let monthCols = [];
            for (let r = 0; r < Math.min(rows.length, 10); r++) {
                for (let c = 0; c < rows[r].length; c++) {
                    const cell = (rows[r][c] || '').trim();
                    if (cell === '3월' || cell === '4월' || cell.match(/^\d+월$/)) {
                        // Found month headers
                        for (let mc = c; mc < rows[r].length; mc++) {
                            const m = (rows[r][mc] || '').trim();
                            if (m.match(/^\d+월$/)) {
                                monthCols.push(mc);
                            }
                        }
                        break;
                    }
                }
                if (monthCols.length > 0) break;
            }

            if (monthCols.length === 0) {
                console.log('Could not find month columns, using fallback');
                return null;
            }

            function extractNumbers(row) {
                return monthCols.map(col => {
                    const val = (row[col] || '').toString().replace(/,/g, '').replace(/\s/g, '');
                    const match = val.match(/-?[\d.]+/);
                    if (val.includes('(') && val.includes(')')) {
                        const num = val.replace(/[()]/g, '').match(/[\d.]+/);
                        return num ? -parseFloat(num[0]) : 0;
                    }
                    return match ? parseFloat(match[0]) : 0;
                });
            }

            for (let r = 0; r < rows.length; r++) {
                const firstCell = (rows[r][0] || '').trim();
                const secondCell = (rows[r][1] || '').trim();
                const label = firstCell || secondCell;

                for (const [key, mapKey] of Object.entries(labelMap)) {
                    if (label.includes(key)) {
                        const nums = extractNumbers(rows[r]);
                        switch(mapKey) {
                            case 'revenue_total': data.revenue.total = nums; break;
                            case 'payapp': data.revenue.payapp = nums; break;
                            case 'kcp_toss': data.revenue.kcp_toss = nums; break;
                            case 'danal': data.revenue.danal = nums; break;
                            case 'salary': data.expenses.salary = nums; break;
                            case 'incentive': data.expenses.incentive = nums; break;
                            case 'freelancer': data.expenses.freelancer = nums; break;
                            case 'fees': data.expenses.fees = nums; break;
                            case 'advertising': data.expenses.advertising = nums; break;
                            case 'welfare': data.expenses.welfare = nums; break;
                            case 'communication': data.expenses.communication = nums; break;
                            case 'supplies': data.expenses.supplies = nums; break;
                            case 'printing': data.expenses.printing = nums; break;
                            case 'rent': data.expenses.rent = nums; break;
                            case 'insurance': data.expenses.insurance = nums; break;
                            case 'transport': data.expenses.transport = nums; break;
                            case 'entertainment': data.expenses.entertainment = nums; break;
                            case 'tax': data.expenses.tax = nums; break;
                            case 'expense_total': data.expenses.total = nums; break;
                            case 'operating_profit': data.operatingProfit = nums; break;
                        }
                        break;
                    }
                }

                // "기타" in revenue context
                if (label === '기타' || label.includes('기타')) {
                    // Check if we're in revenue section (before expenses)
                    let inRevenue = true;
                    for (let pr = r - 1; pr >= Math.max(0, r - 10); pr--) {
                        const pl = (rows[pr][0] || rows[pr][1] || '').trim();
                        if (pl.includes('판매비') || pl.includes('관리비')) {
                            inRevenue = false;
                            break;
                        }
                    }
                    if (inRevenue) {
                        data.revenue.etc = extractNumbers(rows[r]);
                    }
                }
            }

            // Validate
            if (data.revenue.total.length >= 8) {
                data.months = MONTHS.slice(0, data.revenue.total.length);
                return data;
            }
            return null;
        } catch (e) {
            console.log('CSV parse error:', e);
            return null;
        }
    }

    // ============================================================
    // FORMATTING HELPERS
    // ============================================================
    function formatKRW(value) {
        if (value === 0) return '0';
        const abs = Math.abs(value);
        const prefix = value < 0 ? '-' : '';
        if (abs >= 100000000) return prefix + (abs / 100000000).toFixed(1) + '억';
        if (abs >= 10000) return prefix + (abs / 10000).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',') + '만';
        return prefix + abs.toLocaleString();
    }

    function formatFullKRW(value) {
        const prefix = value < 0 ? '-' : '';
        return prefix + Math.abs(value).toLocaleString() + '원';
    }

    function formatPercent(value) {
        return (value >= 0 ? '+' : '') + value.toFixed(1) + '%';
    }

    function sum(arr) {
        return arr.reduce((a, b) => a + b, 0);
    }

    // ============================================================
    // RENDER KPI CARDS
    // ============================================================
    function renderKPIs(data) {
        const totalRevenue = sum(data.revenue.total);
        const totalExpenses = sum(data.expenses.total);
        const totalProfit = sum(data.operatingProfit);
        const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue * 100) : 0;

        // MoM change for last month
        const lastIdx = data.revenue.total.length - 1;
        const prevIdx = lastIdx - 1;
        const revChange = prevIdx >= 0 && data.revenue.total[prevIdx] > 0
            ? ((data.revenue.total[lastIdx] - data.revenue.total[prevIdx]) / data.revenue.total[prevIdx] * 100) : 0;
        const expChange = prevIdx >= 0 && data.expenses.total[prevIdx] > 0
            ? ((data.expenses.total[lastIdx] - data.expenses.total[prevIdx]) / data.expenses.total[prevIdx] * 100) : 0;

        const bestMonth = data.revenue.total.indexOf(Math.max(...data.revenue.total));

        const kpiGrid = document.getElementById('kpiGrid');
        kpiGrid.innerHTML = `
            <div class="kpi-card">
                <div class="kpi-label">총 매출 (연간)</div>
                <div class="kpi-value" style="color: var(--accent-blue)">${formatKRW(totalRevenue)}</div>
                <div class="kpi-sub">
                    <span class="kpi-trend ${revChange >= 0 ? 'trend-up' : 'trend-down'}">
                        ${revChange >= 0 ? '&#9650;' : '&#9660;'} ${Math.abs(revChange).toFixed(1)}%
                    </span>
                    전월 대비 (${data.months[lastIdx]})
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">총 비용 (연간)</div>
                <div class="kpi-value" style="color: var(--accent-red)">${formatKRW(totalExpenses)}</div>
                <div class="kpi-sub">
                    <span class="kpi-trend ${expChange <= 0 ? 'trend-up' : 'trend-down'}">
                        ${expChange >= 0 ? '&#9650;' : '&#9660;'} ${Math.abs(expChange).toFixed(1)}%
                    </span>
                    전월 대비 (${data.months[lastIdx]})
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">총 영업이익 (연간)</div>
                <div class="kpi-value" style="color: ${totalProfit >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${formatKRW(totalProfit)}</div>
                <div class="kpi-sub">
                    평균 영업이익률 <strong>${avgMargin.toFixed(1)}%</strong>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">최고 매출 월</div>
                <div class="kpi-value" style="color: var(--accent-purple)">${data.months[bestMonth]}</div>
                <div class="kpi-sub">
                    ${formatKRW(data.revenue.total[bestMonth])} 달성
                </div>
            </div>
        `;
    }

    // ============================================================
    // CHART RENDERING
    // ============================================================
    const chartColors = {
        blue: 'rgba(59, 130, 246, 1)',
        blueAlpha: 'rgba(59, 130, 246, 0.15)',
        red: 'rgba(239, 68, 68, 1)',
        redAlpha: 'rgba(239, 68, 68, 0.15)',
        green: 'rgba(16, 185, 129, 1)',
        greenAlpha: 'rgba(16, 185, 129, 0.15)',
        purple: 'rgba(139, 92, 246, 1)',
        purpleAlpha: 'rgba(139, 92, 246, 0.15)',
        yellow: 'rgba(245, 158, 11, 1)',
        yellowAlpha: 'rgba(245, 158, 11, 0.15)',
        cyan: 'rgba(6, 182, 212, 1)',
        cyanAlpha: 'rgba(6, 182, 212, 0.15)',
        pink: 'rgba(236, 72, 153, 1)',
        pinkAlpha: 'rgba(236, 72, 153, 0.15)',
        orange: 'rgba(249, 115, 22, 1)',
        orangeAlpha: 'rgba(249, 115, 22, 0.15)',
    };

    Chart.defaults.color = '#94a3b8';
    Chart.defaults.borderColor = 'rgba(51, 65, 85, 0.5)';
    Chart.defaults.font.family = "'Noto Sans KR', sans-serif";

    function destroyCharts() {
        Object.values(chartInstances).forEach(c => c.destroy());
        chartInstances = {};
    }

    function renderCharts(data) {
        destroyCharts();
        renderMainChart(data);
        renderRevenueChannelChart(data);
        renderExpenseBreakdownChart(data);
        renderMarginChart(data);
        renderChannelTrendChart(data);
        renderExpenseTrendChart(data);
        renderCumulativeChart(data);
        renderLaborRatioChart(data);
    }

    function renderMainChart(data) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        chartInstances.main = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.months,
                datasets: [
                    {
                        label: '매출',
                        data: data.revenue.total,
                        backgroundColor: chartColors.blueAlpha,
                        borderColor: chartColors.blue,
                        borderWidth: 2,
                        borderRadius: 6,
                        order: 2
                    },
                    {
                        label: '비용',
                        data: data.expenses.total,
                        backgroundColor: chartColors.redAlpha,
                        borderColor: chartColors.red,
                        borderWidth: 2,
                        borderRadius: 6,
                        order: 3
                    },
                    {
                        label: '영업이익',
                        data: data.operatingProfit,
                        type: 'line',
                        borderColor: chartColors.green,
                        backgroundColor: chartColors.greenAlpha,
                        borderWidth: 3,
                        pointRadius: 5,
                        pointBackgroundColor: data.operatingProfit.map(v => v >= 0 ? chartColors.green : chartColors.red),
                        pointBorderColor: '#1e293b',
                        pointBorderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: ctx => ctx.dataset.label + ': ' + formatFullKRW(ctx.raw)
                        }
                    },
                    legend: { position: 'top', labels: { usePointStyle: true, padding: 20 } }
                },
                scales: {
                    y: {
                        ticks: {
                            callback: v => formatKRW(v)
                        },
                        grid: { color: 'rgba(51, 65, 85, 0.3)' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }

    function renderRevenueChannelChart(data) {
        const ctx = document.getElementById('revenueChannelChart').getContext('2d');
        const totals = {
            '페이앱': sum(data.revenue.payapp),
            'KCP/토스페이': sum(data.revenue.kcp_toss),
            '다날': sum(data.revenue.danal),
            '기타': sum(data.revenue.etc)
        };

        chartInstances.revenueChannel = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(totals),
                datasets: [{
                    data: Object.values(totals),
                    backgroundColor: [chartColors.blue, chartColors.purple, chartColors.cyan, chartColors.yellow],
                    borderColor: '#1e293b',
                    borderWidth: 3,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16 } },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const pct = (ctx.raw / total * 100).toFixed(1);
                                return `${ctx.label}: ${formatKRW(ctx.raw)} (${pct}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderExpenseBreakdownChart(data) {
        const ctx = document.getElementById('expenseBreakdownChart').getContext('2d');
        const items = [
            { label: '급여', data: sum(data.expenses.salary), color: chartColors.blue },
            { label: '프리랜서', data: sum(data.expenses.freelancer), color: chartColors.purple },
            { label: '지급수수료', data: sum(data.expenses.fees), color: chartColors.cyan },
            { label: '광고선전비', data: sum(data.expenses.advertising), color: chartColors.yellow },
            { label: '인센티브', data: sum(data.expenses.incentive), color: chartColors.green },
            { label: '임차료', data: sum(data.expenses.rent), color: chartColors.pink },
            { label: '기타', data: sum(data.expenses.welfare) + sum(data.expenses.communication) + sum(data.expenses.supplies) + sum(data.expenses.printing) + sum(data.expenses.insurance) + sum(data.expenses.transport) + sum(data.expenses.entertainment) + sum(data.expenses.tax), color: chartColors.orange }
        ];

        items.sort((a, b) => b.data - a.data);

        chartInstances.expenseBreakdown = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: items.map(i => i.label),
                datasets: [{
                    data: items.map(i => i.data),
                    backgroundColor: items.map(i => i.color),
                    borderColor: '#1e293b',
                    borderWidth: 3,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16 } },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const pct = (ctx.raw / total * 100).toFixed(1);
                                return `${ctx.label}: ${formatKRW(ctx.raw)} (${pct}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderMarginChart(data) {
        const ctx = document.getElementById('marginChart').getContext('2d');
        const margins = data.months.map((_, i) =>
            data.revenue.total[i] > 0 ? (data.operatingProfit[i] / data.revenue.total[i] * 100) : 0
        );

        chartInstances.margin = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.months,
                datasets: [{
                    label: '영업이익률',
                    data: margins,
                    backgroundColor: margins.map(v => v >= 0 ? 'rgba(16, 185, 129, 0.6)' : 'rgba(239, 68, 68, 0.6)'),
                    borderColor: margins.map(v => v >= 0 ? chartColors.green : chartColors.red),
                    borderWidth: 2,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => `영업이익률: ${ctx.raw.toFixed(1)}%`
                        }
                    }
                },
                scales: {
                    y: {
                        ticks: { callback: v => v + '%' },
                        grid: { color: 'rgba(51, 65, 85, 0.3)' }
                    },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function renderChannelTrendChart(data) {
        const ctx = document.getElementById('channelTrendChart').getContext('2d');
        chartInstances.channelTrend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.months,
                datasets: [
                    { label: '페이앱', data: data.revenue.payapp, borderColor: chartColors.blue, backgroundColor: chartColors.blueAlpha, fill: true, tension: 0.3, pointRadius: 3 },
                    { label: 'KCP/토스페이', data: data.revenue.kcp_toss, borderColor: chartColors.purple, backgroundColor: chartColors.purpleAlpha, fill: true, tension: 0.3, pointRadius: 3 },
                    { label: '다날', data: data.revenue.danal, borderColor: chartColors.cyan, backgroundColor: chartColors.cyanAlpha, fill: true, tension: 0.3, pointRadius: 3 },
                    { label: '기타', data: data.revenue.etc, borderColor: chartColors.yellow, backgroundColor: chartColors.yellowAlpha, fill: true, tension: 0.3, pointRadius: 3 },
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { position: 'top', labels: { usePointStyle: true, padding: 16 } },
                    tooltip: {
                        callbacks: { label: ctx => ctx.dataset.label + ': ' + formatKRW(ctx.raw) }
                    }
                },
                scales: {
                    y: { ticks: { callback: v => formatKRW(v) }, grid: { color: 'rgba(51, 65, 85, 0.3)' }, stacked: false },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function renderExpenseTrendChart(data) {
        const ctx = document.getElementById('expenseTrendChart').getContext('2d');
        chartInstances.expenseTrend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.months,
                datasets: [
                    { label: '급여', data: data.expenses.salary, borderColor: chartColors.blue, borderWidth: 2, tension: 0.3, pointRadius: 3 },
                    { label: '프리랜서', data: data.expenses.freelancer, borderColor: chartColors.purple, borderWidth: 2, tension: 0.3, pointRadius: 3 },
                    { label: '지급수수료', data: data.expenses.fees, borderColor: chartColors.cyan, borderWidth: 2, tension: 0.3, pointRadius: 3 },
                    { label: '광고선전비', data: data.expenses.advertising, borderColor: chartColors.yellow, borderWidth: 2, tension: 0.3, pointRadius: 3 },
                    { label: '인센티브', data: data.expenses.incentive, borderColor: chartColors.green, borderWidth: 2, tension: 0.3, pointRadius: 3 },
                    { label: '임차료', data: data.expenses.rent, borderColor: chartColors.pink, borderWidth: 2, tension: 0.3, pointRadius: 3 },
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { position: 'top', labels: { usePointStyle: true, padding: 16 } },
                    tooltip: {
                        callbacks: { label: ctx => ctx.dataset.label + ': ' + formatFullKRW(ctx.raw) }
                    }
                },
                scales: {
                    y: { ticks: { callback: v => formatKRW(v) }, grid: { color: 'rgba(51, 65, 85, 0.3)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function renderCumulativeChart(data) {
        const ctx = document.getElementById('cumulativeChart').getContext('2d');
        let cumRev = [], cumExp = [], cumProfit = [];
        let sr = 0, se = 0, sp = 0;
        data.months.forEach((_, i) => {
            sr += data.revenue.total[i]; se += data.expenses.total[i]; sp += data.operatingProfit[i];
            cumRev.push(sr); cumExp.push(se); cumProfit.push(sp);
        });

        chartInstances.cumulative = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.months,
                datasets: [
                    { label: '누적 매출', data: cumRev, borderColor: chartColors.blue, backgroundColor: chartColors.blueAlpha, fill: true, tension: 0.3, borderWidth: 2 },
                    { label: '누적 비용', data: cumExp, borderColor: chartColors.red, backgroundColor: chartColors.redAlpha, fill: true, tension: 0.3, borderWidth: 2 },
                    { label: '누적 이익', data: cumProfit, borderColor: chartColors.green, backgroundColor: chartColors.greenAlpha, fill: true, tension: 0.3, borderWidth: 2 },
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { position: 'top', labels: { usePointStyle: true, padding: 16 } },
                    tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + formatKRW(ctx.raw) } }
                },
                scales: {
                    y: { ticks: { callback: v => formatKRW(v) }, grid: { color: 'rgba(51, 65, 85, 0.3)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function renderLaborRatioChart(data) {
        const ctx = document.getElementById('laborRatioChart').getContext('2d');
        const laborRatios = data.months.map((_, i) => {
            const labor = data.expenses.salary[i] + data.expenses.incentive[i] + data.expenses.freelancer[i];
            return data.revenue.total[i] > 0 ? (labor / data.revenue.total[i] * 100) : 0;
        });
        const adRatios = data.months.map((_, i) =>
            data.revenue.total[i] > 0 ? (data.expenses.advertising[i] / data.revenue.total[i] * 100) : 0
        );

        chartInstances.laborRatio = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.months,
                datasets: [
                    { label: '인건비율 (급여+인센+프리)', data: laborRatios, borderColor: chartColors.purple, backgroundColor: chartColors.purpleAlpha, fill: true, tension: 0.3, borderWidth: 2 },
                    { label: '광고비율', data: adRatios, borderColor: chartColors.yellow, backgroundColor: chartColors.yellowAlpha, fill: true, tension: 0.3, borderWidth: 2 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { position: 'top', labels: { usePointStyle: true, padding: 16 } },
                    tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.raw.toFixed(1) + '%' } }
                },
                scales: {
                    y: { ticks: { callback: v => v + '%' }, grid: { color: 'rgba(51, 65, 85, 0.3)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // ============================================================
    // BUSINESS INSIGHTS
    // ============================================================
    function renderInsights(data) {
        const totalRevenue = sum(data.revenue.total);
        const totalExpenses = sum(data.expenses.total);
        const totalProfit = sum(data.operatingProfit);
        const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue * 100) : 0;

        const bestMonthIdx = data.revenue.total.indexOf(Math.max(...data.revenue.total));
        const worstMonthIdx = data.operatingProfit.indexOf(Math.min(...data.operatingProfit));

        const totalLabor = sum(data.expenses.salary) + sum(data.expenses.incentive) + sum(data.expenses.freelancer);
        const laborRatio = totalExpenses > 0 ? (totalLabor / totalExpenses * 100) : 0;

        const totalAd = sum(data.expenses.advertising);
        const totalFreelancer = sum(data.expenses.freelancer);

        // Channel diversification
        const payappShare = sum(data.revenue.payapp) / totalRevenue * 100;
        const etcShare = sum(data.revenue.etc) / totalRevenue * 100;

        // Growth rates
        const q3Rev = sum(data.revenue.total.slice(5, 8)); // Aug, Sep, Oct (indices 5,6,7)
        const q2Rev = sum(data.revenue.total.slice(2, 5)); // May, Jun, Jul (indices 2,3,4)
        const qGrowth = q2Rev > 0 ? ((q3Rev - q2Rev) / q2Rev * 100) : 0;

        // Expense volatility
        const freelancerVals = data.expenses.freelancer.filter(v => v > 0);
        const freelancerMax = Math.max(...freelancerVals);
        const freelancerMin = Math.min(...freelancerVals);
        const freelancerVolatility = freelancerMin > 0 ? ((freelancerMax / freelancerMin - 1) * 100) : 0;

        // Recent trend (last 3 months)
        const last3Rev = data.revenue.total.slice(-3);
        const last3Profit = data.operatingProfit.slice(-3);
        const profitableMonths = data.operatingProfit.filter(v => v > 0).length;

        const insights = [
            {
                icon: '&#128200;',
                iconBg: 'rgba(59, 130, 246, 0.15)',
                title: '매출 최고 성과',
                desc: `<strong>${data.months[bestMonthIdx]}</strong>에 ${formatKRW(data.revenue.total[bestMonthIdx])}으로 연중 최고 매출을 달성했습니다. 이 달의 성과 요인을 분석하여 반복 가능한 전략으로 체계화할 필요가 있습니다.`,
                metricLabel: '연간 대비 비중',
                metricValue: (data.revenue.total[bestMonthIdx] / totalRevenue * 100).toFixed(1) + '%'
            },
            {
                icon: '&#9888;&#65039;',
                iconBg: 'rgba(239, 68, 68, 0.15)',
                title: '수익성 주의 구간',
                desc: `<strong>${data.months[worstMonthIdx]}</strong>에 영업이익 ${formatKRW(data.operatingProfit[worstMonthIdx])}으로 가장 낮은 수익성을 기록했습니다. ${profitableMonths}/${data.months.length}개월이 흑자이며, 비용 관리 강화가 필요합니다.`,
                metricLabel: '흑자 비율',
                metricValue: (profitableMonths / data.months.length * 100).toFixed(0) + '%'
            },
            {
                icon: '&#128101;',
                iconBg: 'rgba(139, 92, 246, 0.15)',
                title: '인건비 구조 분석',
                desc: `인건비(급여+인센티브+프리랜서)가 총 비용의 <strong>${laborRatio.toFixed(1)}%</strong>를 차지합니다. 특히 프리랜서 비용(${formatKRW(totalFreelancer)})의 변동폭이 ${freelancerVolatility.toFixed(0)}%로 매우 큽니다.`,
                metricLabel: '프리랜서/총비용',
                metricValue: (totalFreelancer / totalExpenses * 100).toFixed(1) + '%'
            },
            {
                icon: '&#128226;',
                iconBg: 'rgba(245, 158, 11, 0.15)',
                title: '광고 효율성',
                desc: `연간 광고비 ${formatKRW(totalAd)}로 매출 대비 <strong>${(totalAd / totalRevenue * 100).toFixed(1)}%</strong> 수준입니다. 12월 광고비가 급증(${formatKRW(data.expenses.advertising[9])})했으므로 ROI 검증이 필요합니다.`,
                metricLabel: '광고비/매출',
                metricValue: (totalAd / totalRevenue * 100).toFixed(1) + '%'
            },
            {
                icon: '&#128176;',
                iconBg: 'rgba(16, 185, 129, 0.15)',
                title: '매출 채널 다각화',
                desc: `페이앱 비중이 <strong>${payappShare.toFixed(1)}%</strong>로 여전히 주력이나, '기타' 채널이 ${etcShare.toFixed(1)}%까지 성장했습니다. 9~11월에 기타 채널 매출이 크게 증가하여 채널 다각화가 진행 중입니다.`,
                metricLabel: '기타 채널 비중',
                metricValue: etcShare.toFixed(1) + '%'
            },
            {
                icon: '&#128640;',
                iconBg: 'rgba(6, 182, 212, 0.15)',
                title: '성장 전략 제안',
                desc: `8월 최고 매출 달성 후 하반기 매출이 감소 추세입니다. 프리랜서 비용 안정화, 광고 ROI 개선, 기타 채널 확대를 통해 안정적 수익 구조 구축이 핵심 과제입니다.`,
                metricLabel: '평균 영업이익률',
                metricValue: avgMargin.toFixed(1) + '%'
            }
        ];

        const grid = document.getElementById('insightsGrid');
        grid.innerHTML = insights.map(ins => `
            <div class="insight-card">
                <div class="insight-icon" style="background: ${ins.iconBg}">${ins.icon}</div>
                <div class="insight-title">${ins.title}</div>
                <div class="insight-desc">${ins.desc}</div>
                <div class="insight-metric">
                    <span class="insight-metric-label">${ins.metricLabel}</span>
                    <span class="insight-metric-value">${ins.metricValue}</span>
                </div>
            </div>
        `).join('');
    }

    // ============================================================
    // DATA TABLE
    // ============================================================
    function renderTable(data) {
        const table = document.getElementById('dataTable');
        const allMonths = data.months;

        const rows = [
            { label: '매출 합계', values: data.revenue.total, class: 'row-total' },
            { label: '  페이앱', values: data.revenue.payapp },
            { label: '  KCP/토스페이', values: data.revenue.kcp_toss },
            { label: '  다날', values: data.revenue.danal },
            { label: '  기타', values: data.revenue.etc },
            { label: '비용 합계', values: data.expenses.total, class: 'row-total' },
            { label: '  급여', values: data.expenses.salary },
            { label: '  인센티브', values: data.expenses.incentive },
            { label: '  프리랜서', values: data.expenses.freelancer },
            { label: '  지급수수료', values: data.expenses.fees },
            { label: '  광고선전비', values: data.expenses.advertising },
            { label: '  임차료', values: data.expenses.rent },
            { label: '  복리후생비', values: data.expenses.welfare },
            { label: '  기타비용', values: allMonths.map((_, i) =>
                (data.expenses.communication[i] || 0) + (data.expenses.supplies[i] || 0) +
                (data.expenses.printing[i] || 0) + (data.expenses.insurance[i] || 0) +
                (data.expenses.transport[i] || 0) + (data.expenses.entertainment[i] || 0) +
                (data.expenses.tax[i] || 0)
            )},
            { label: '영업이익', values: data.operatingProfit, class: 'row-profit' }
        ];

        // Annual totals
        const annualCol = rows.map(r => sum(r.values));

        let html = '<thead><tr><th>항목</th>';
        allMonths.forEach(m => html += `<th>${m}</th>`);
        html += '<th>연간합계</th></tr></thead><tbody>';

        rows.forEach((row, ri) => {
            const cls = row.class || '';
            html += `<tr class="${cls}">`;
            html += `<td>${row.label}</td>`;
            row.values.forEach(v => {
                const profitClass = row.class === 'row-profit' ? (v >= 0 ? 'positive' : 'negative') : '';
                html += `<td class="${profitClass}">${v === 0 ? '-' : (v < 0 ? '(' + Math.abs(v).toLocaleString() + ')' : v.toLocaleString())}</td>`;
            });
            const av = annualCol[ri];
            const profitClass = row.class === 'row-profit' ? (av >= 0 ? 'positive' : 'negative') : '';
            html += `<td class="${profitClass}" style="font-weight:600">${av === 0 ? '-' : (av < 0 ? '(' + Math.abs(av).toLocaleString() + ')' : av.toLocaleString())}</td>`;
            html += '</tr>';
        });

        html += '</tbody>';
        table.innerHTML = html;
    }

    // ============================================================
    // MAIN
    // ============================================================
    async function loadDashboard() {
        const data = await fetchSheetData();
        currentData = data;
        renderKPIs(data);
        renderCharts(data);
        renderInsights(data);
        renderTable(data);

        const now = new Date();
        document.getElementById('lastUpdate').textContent =
            `마지막 업데이트: ${now.toLocaleString('ko-KR')}`;

        document.getElementById('loadingOverlay').classList.add('hidden');
    }

    async function refreshData() {
        document.getElementById('loadingOverlay').classList.remove('hidden');
        await loadDashboard();
    }

    // Initial load
    loadDashboard();

    // Auto-refresh
    setInterval(async () => {
        console.log('Auto-refreshing data...');
        const data = await fetchSheetData();
        currentData = data;
        renderKPIs(data);
        renderCharts(data);
        renderInsights(data);
        renderTable(data);
        const now = new Date();
        document.getElementById('lastUpdate').textContent =
            `마지막 업데이트: ${now.toLocaleString('ko-KR')}`;
    }, AUTO_REFRESH_MS);
    </script>
</body>
</html>
